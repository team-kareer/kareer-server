name: ci-main
on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
    paths-ignore:
      - '**/*.md'

jobs:
  build:
    runs-on: ubuntu-latest
    environment: main

    permissions:
      contents: read
      checks: write
      pull-requests: write

    steps:
      # 1. ÏΩîÎìú Ï≤¥ÌÅ¨ÏïÑÏõÉ
      - name: üîÑ Code Checkout
        uses: actions/checkout@v4

      # 2. JDK 21 ÏÑ§Ï†ï
      - name: ‚õèÔ∏è Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3. Gradle ÏÑ§Ï†ï
      - name: üõ†Ô∏è Set up Gradle
        uses: gradle/actions/setup-gradle@v3

      # 4. gradlew Ïã§Ìñâ Í∂åÌïú Î∂ÄÏó¨
      - name: üó£Ô∏è Grant execute permission for gradlew
        run: chmod +x gradlew

      # 5. ÎπåÎìú
      - name: üîÜ Build
        run: ./gradlew clean build -x test

      # 6. AWS Ïù∏Ï¶ù
      - name: üîê Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 7. ECR Î°úÍ∑∏Ïù∏
      - name: üîë Login to ECR
        run: |
          aws ecr get-login-password \
            --region ${{ secrets.AWS_REGION }} \
          | docker login \
            --username AWS \
            --password-stdin ${{ secrets.ECR_REGISTRY }}

      # 8. ECR Push
      - name: üì¶ Build & Push Image to ECR (Jib)
        env:
          ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
          IMAGE_TAG: ${{ github.sha }}
          JIB_TESSERACT_BASE_IMAGE: ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:tesseract-base
        run: |
          ./gradlew jib

      # 9. Discord ÏïåÎ¶º
      - name: ‚úâÔ∏è Send CI Result to Discord
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          JOB_STATUS: ${{ job.status }}
          ACTOR: ${{ github.actor }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          if [ "$JOB_STATUS" = "success" ]; then
            STATUS_EMOJI="‚úÖ"
            STATUS_TEXT="ÏÑ±Í≥µ"
            COLOR=3066993
          else
            STATUS_EMOJI="‚ùå"
            STATUS_TEXT="Ïã§Ìå®"
            COLOR=15158332
          fi
          
          PR_URL="https://github.com/$REPO/pull/$PR_NUMBER"
          DEBUG_URL="https://github.com/$REPO/actions/runs/$RUN_ID"
          
          payload=$(jq -n \
            --arg title "$STATUS_EMOJI Main CI $STATUS_TEXT" \
            --arg pr_title "$PR_TITLE" \
            --arg pr_url "$PR_URL" \
            --arg actor "$ACTOR" \
            --arg debug_url "$DEBUG_URL" \
            --argjson color "$COLOR" \
            '{
              embeds: [
                {
                  title: $title,
                  color: $color,
                  fields: [
                    {
                      name: "üìã Pull Request",
                      value: "[\($pr_title)](\($pr_url))",
                      inline: false
                    },
                    {
                      name: "üë§ Îã¥ÎãπÏûê",
                      value: $actor,
                      inline: false
                    },
                    {
                      name: "üîç Î°úÍ∑∏",
                      value: "[Actions Î°úÍ∑∏ Î≥¥Í∏∞](\($debug_url))",
                      inline: false
                    }
                  ]
                }
              ]
            }')
          
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$payload" \
            "$DISCORD_WEBHOOK"
