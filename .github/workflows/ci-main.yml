name: ci-main
on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
    paths-ignore:
      - '**/*.md'

jobs:
  build:
    runs-on: ubuntu-latest
    environment: main

    permissions:
      contents: read
      checks: write
      pull-requests: write

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ğŸ”„ Code Checkout
        uses: actions/checkout@v4

      # 2. JDK 21 ì„¤ì •
      - name: â›ï¸ Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3. Gradle ì„¤ì •
      - name: ğŸ› ï¸ Set up Gradle
        uses: gradle/actions/setup-gradle@v3

      # 4. gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: ğŸ—£ï¸ Grant execute permission for gradlew
        run: chmod +x gradlew

      # 5. ë¹Œë“œ
      - name: ğŸ”† Build
        run: ./gradlew clean build -x test

      # 6. AWS ì¸ì¦
      - name: ğŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 7. ECR ë¡œê·¸ì¸
      - name: ğŸ”‘ Login to ECR
        run: |
          aws ecr get-login-password \
            --region ${{ secrets.AWS_REGION }} \
          | docker login \
            --username AWS \
            --password-stdin ${{ secrets.ECR_REGISTRY }}

      # 8. ECR Push
      - name: ğŸ“¦ Build & Push Image to ECR (Jib)
        env:
          ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          ./gradlew jib

      # 9. Discord ì•Œë¦¼
      - name: âœ‰ï¸ Send CI Result to Discord
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          JOB_STATUS: ${{ job.status }}
          ACTOR: ${{ github.actor }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          if [ "$JOB_STATUS" = "success" ]; then
            STATUS_EMOJI="âœ…"
            STATUS_TEXT="ì„±ê³µ"
            COLOR=3066993
          else
            STATUS_EMOJI="âŒ"
            STATUS_TEXT="ì‹¤íŒ¨"
            COLOR=15158332
          fi
          
          PR_URL="https://github.com/$REPO/pull/$PR_NUMBER"
          DEBUG_URL="https://github.com/$REPO/actions/runs/$RUN_ID"
          
          payload=$(jq -n \
            --arg title "$STATUS_EMOJI Main CI $STATUS_TEXT" \
            --arg pr_title "$PR_TITLE" \
            --arg pr_url "$PR_URL" \
            --arg actor "$ACTOR" \
            --arg debug_url "$DEBUG_URL" \
            --argjson color "$COLOR" \
            '{
              embeds: [
                {
                  title: $title,
                  color: $color,
                  fields: [
                    {
                      name: "ğŸ“‹ Pull Request",
                      value: "[\($pr_title)](\($pr_url))",
                      inline: false
                    },
                    {
                      name: "ğŸ‘¤ ë‹´ë‹¹ì",
                      value: $actor,
                      inline: false
                    },
                    {
                      name: "ğŸ” ë¡œê·¸",
                      value: "[Actions ë¡œê·¸ ë³´ê¸°](\($debug_url))",
                      inline: false
                    }
                  ]
                }
              ]
            }')
          
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$payload" \
            "$DISCORD_WEBHOOK"
